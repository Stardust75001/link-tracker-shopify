name: üöÄ Deploy + Sentry Release

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: ‚è¨ Checkout repo
        uses: actions/checkout@v4

      - name: üìù R√©cup√©ration du num√©ro de version automatique
        id: version
        run: |
          VERSION="v$(date +'%Y.%m.%d').${{ github.run_number }}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: ‚úèÔ∏è Inject version in theme.liquid et layout
        run: |
          sed -i 's|release: .*|release: "${{ env.VERSION }}"|g' sections/theme.liquid || true
          sed -i 's|release: .*|release: "${{ env.VERSION }}"|g' layout/theme.liquid || true
          sed -i 's|<meta name="sentry-release" content="shop-theme-v.*">|<meta name="sentry-release" content="shop-theme-${{ env.VERSION }}">|g' layout/theme.liquid || true
          sed -i 's|Sentry.setTag("release_tag", "shop-theme-v.*");|Sentry.setTag("release_tag", "shop-theme-${{ env.VERSION }}");|g' layout/theme.liquid || true

      - name: üì§ Commit & Push version bump
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "üîÅ Auto version bump ${{ env.VERSION }}" || echo "‚úÖ Nothing to commit"
          git push

      - name: üö® Create Sentry Release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: thepetsociety
          SENTRY_PROJECT: shopify-frontend
        with:
          environment: production
          version: ${{ env.VERSION }}
