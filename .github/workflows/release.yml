name: üöÄ Deploy + Sentry Release

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: ‚è¨ Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }} # Utilise le PAT pour autoriser git push

      - name: üìù G√©n√©ration automatique de version
        id: version
        run: |
          VERSION="v$(date +'%Y.%m.%d').${{ github.run_number }}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: ‚úèÔ∏è Injection version dans theme.liquid et layout
        run: |
          sed -i 's|release: .*|release: "${{ env.VERSION }}"|g' sections/theme.liquid || true
          sed -i 's|release: .*|release: "${{ env.VERSION }}"|g' layout/theme.liquid || true
          sed -i 's|<meta name="sentry-release" content="shop-theme-v.*">|<meta name="sentry-release" content="shop-theme-${{ env.VERSION }}">|g' layout/theme.liquid || true

      - name: üì§ Commit & Push version bump
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add .
          git diff --cached --quiet || git commit -m "üîÅ Auto version bump ${{ env.VERSION }}"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git

      - name: üö® Create Sentry Release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: falcon-trading-ep
          SENTRY_PROJECT: other
        with:
          environment: production
          version: ${{ env.VERSION }}
